<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Video Generator</title>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f6; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { background: white; padding: 2rem; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 100%; max-width: 450px; }
        h1 { font-size: 24px; color: #1a1a1a; margin-bottom: 1.5rem; text-align: center; }
        
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #4a4a4a; font-size: 14px; }
        input { width: 100%; padding: 12px; margin-bottom: 1.2rem; border: 1px solid #e0e0e0; border-radius: 8px; box-sizing: border-box; font-size: 14px; transition: border 0.3s; }
        input:focus { border-color: #007bff; outline: none; }
        
        button { width: 100%; padding: 14px; background-color: #007bff; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background 0.3s; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        #status { margin-top: 1rem; font-size: 14px; color: #666; text-align: center; min-height: 20px; font-weight: 500; }
        #result { margin-top: 1.5rem; text-align: center; }
        video { width: 100%; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .download-link { display: inline-block; margin-top: 10px; color: #007bff; text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –≤—ñ–¥–µ–æ</h1>

    <label for="imgUrl">–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Ñ–æ—Ç–æ (Direct Link)</label>
    <input type="text" id="imgUrl" placeholder="https://example.com/image.jpg">

    <label for="prompt">–©–æ –º–∞—î –≤—ñ–¥–±—É–≤–∞—Ç–∏—Å—è? (–ü—Ä–æ–º–ø—Ç)</label>
    <input type="text" id="prompt" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: water flowing, camera zoom in">

    <button id="btn">–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –≤—ñ–¥–µ–æ</button>

    <p id="status"></p>
    <div id="result"></div>
</div>

<script>
    document.getElementById('btn').onclick = async () => {
        const status = document.getElementById('status');
        const resultDiv = document.getElementById('result');
        const imgUrl = document.getElementById('imgUrl').value;
        const prompt = document.getElementById('prompt').value;
        const btn = document.getElementById('btn');

        if (!imgUrl) {
            status.innerText = "‚ùå –ë—É–¥—å –ª–∞—Å–∫–∞, –≤—Å—Ç–∞–≤ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Ñ–æ—Ç–æ";
            return;
        }

        status.innerText = "üöÄ –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –∑–∞–ø–∏—Ç—É –¥–æ —Å–µ—Ä–≤–µ—Ä–∞...";
        resultDiv.innerHTML = ""; 
        btn.disabled = true;

        let attempts = 0;
        const MAX_ATTEMPTS = 60; // 5 —Ö–≤–∏–ª–∏–Ω –º–∞–∫—Å–∏–º—É–º
        
        try {
            // 1. –ó–ê–ü–£–°–ö
            const response = await fetch('/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image_url: imgUrl, prompt: prompt })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || "–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫—É");
            }

            const data = await response.json();
            const request_id = data.request_id;
            
            status.innerText = "‚è≥ –í—ñ–¥–µ–æ –≤ —á–µ—Ä–∑—ñ. –û—á—ñ–∫—É—î–º–æ...";

            // 2. –¶–ò–ö–õ –ü–ï–†–ï–í–Ü–†–ö–ò –°–¢–ê–¢–£–°–£
            const pollInterval = setInterval(async () => {
                attempts++;
                
                if (attempts > MAX_ATTEMPTS) {
                    clearInterval(pollInterval);
                    status.innerText = "‚è∞ –ß–∞—Å –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è –≤–∏—á–µ—Ä–ø–∞–Ω–æ. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.";
                    btn.disabled = false;
                    return;
                }
                
                try {
                    const checkRes = await fetch(`/status/${request_id}`);
                    
                    if (checkRes.status === 200) {
                        const result = await checkRes.json();
                        
                        // –î–Ü–ê–ì–ù–û–°–¢–ò–ö–ê: –≤–∏–≤–æ–¥–∏–º–æ –æ–±'—î–∫—Ç —É –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞
                        console.log("üì¶ –û—Ç—Ä–∏–º–∞–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç:", result);
                        
                        // –†–û–ó–£–ú–ù–ò–ô –ü–û–®–£–ö –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –≤—ñ–¥–µ–æ (–ø—ñ–¥ —Ä—ñ–∑–Ω—ñ —Ñ–æ—Ä–º–∞—Ç–∏ Fal.ai)
                        const finalVideoUrl = result.video?.url || result.video_url || result.url;

                        if (finalVideoUrl) {
                            clearInterval(pollInterval);
                            status.innerText = "‚ú® –ì–æ—Ç–æ–≤–æ!";
                            resultDiv.innerHTML = `
                                <video controls autoplay loop style="width:100%; border-radius:12px;">
                                    <source src="${finalVideoUrl}" type="video/mp4">
                                </video>
                                <a href="${finalVideoUrl}" target="_blank" class="download-link">üîó –í—ñ–¥–∫—Ä–∏—Ç–∏ –≤—ñ–¥–µ–æ</a>
                            `;
                            btn.disabled = false;
                        } else {
                            clearInterval(pollInterval);
                            console.error("‚ùå –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ URL –≤—ñ–¥–µ–æ —É –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ:", result);
                            status.innerText = "‚ö†Ô∏è –í—ñ–¥–µ–æ –≥–æ—Ç–æ–≤–µ, –∞–ª–µ —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–∏—Ö –∑–º—ñ–Ω–∏–≤—Å—è. –î–∏–≤–∏—Å—å F12.";
                            btn.disabled = false;
                        }
                    } else if (checkRes.status === 202) {
                        const partialData = await checkRes.json();
                        status.innerText = `‚è≥ –û–±—Ä–æ–±–∫–∞... (${partialData.status} | —Å–ø—Ä–æ–±–∞ ${attempts}/${MAX_ATTEMPTS})`;
                    } else {
                        const errData = await checkRes.json();
                        console.error("–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞:", errData);
                    }
                } catch (pollError) {
                    console.error("–ú–µ—Ä–µ–∂–µ–≤–∞ –ø–æ–º–∏–ª–∫–∞ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è:", pollError);
                }
            }, 5000);

        } catch (e) {
            console.error("–ü–æ–º–∏–ª–∫–∞:", e);
            status.innerText = "‚ùå " + e.message;
            btn.disabled = false;
        }
    };
</script>

</body>
</html>