<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Video Generator Pro | 3x Unique</title>
    <style>
        /* –ì–ª–æ–±–∞–ª—å–Ω–∏–π —Ñ—ñ–∫—Å –≥–µ–æ–º–µ—Ç—Ä—ñ—ó –±–ª–æ–∫—ñ–≤ */
        * { box-sizing: border-box; }

        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 2rem 1rem; }
        .container { background: white; padding: 2.5rem; border-radius: 20px; box-shadow: 0 12px 32px rgba(0,0,0,0.08); width: 100%; max-width: 600px; margin-bottom: 2rem; position: relative; }
        h1 { font-size: 26px; color: #1a1a1a; margin-top: 0; margin-bottom: 1.5rem; text-align: center; }
        
        .header-actions { display: flex; justify-content: flex-end; margin-bottom: 1rem; }
        .gallery-btn { background: #e6f0ff; color: #0052cc; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .gallery-btn:hover { background: #cce0ff; }

        label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 14px; }
        input[type="text"], select { width: 100%; padding: 14px; margin-bottom: 1rem; border: 1.5px solid #e1e4e8; border-radius: 10px; font-size: 15px; outline: none; }
        
        .drop-zone { width: 100%; border: 2px dashed #0052cc; border-radius: 12px; padding: 2rem; text-align: center; cursor: pointer; background: #f8faff; color: #0052cc; margin-bottom: 1rem; position: relative; transition: all 0.2s; }
        .drop-zone:hover, .drop-zone.dragover { background: #e6f0ff; }
        .drop-zone img { max-width: 100%; max-height: 250px; border-radius: 8px; display: none; margin: 0 auto; object-fit: contain; }
        .drop-text { pointer-events: none; font-weight: 500;}

        .divider { text-align: center; margin: 5px 0 15px; color: #999; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }

        button.primary-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, #0052cc 0%, #0042a3 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.1s; }
        button.primary-btn:active { transform: scale(0.98); }
        button.primary-btn:disabled { background: #ccc; cursor: not-allowed; }

        .progress-container { width: 100%; height: 8px; background-color: #e1e4e8; border-radius: 4px; margin-top: 20px; overflow: hidden; display: none; }
        .progress-bar { height: 100%; width: 0%; background-color: #0052cc; transition: width 0.4s ease; }
        #status { margin-top: 1rem; font-size: 14px; color: #666; text-align: center; font-weight: 500; }
        
        .video-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 1.5rem; }
        .video-card { background: #f8f9fa; border: 1px solid #e1e4e8; border-radius: 12px; padding: 10px; text-align: center; }
        .video-card h3 { font-size: 13px; margin: 0 0 10px 0; color: #333; }
        .video-card video { width: 100%; border-radius: 8px; background: #000; margin-bottom: 10px; }
        .action-btn { display: inline-block; width: 100%; padding: 8px; border: 1px solid #0052cc; background: white; border-radius: 6px; font-weight: 600; color: #0052cc; cursor: pointer; text-decoration: none; font-size: 12px;}
        
        .gallery-overlay { display: none; background: white; padding: 2rem; border-radius: 20px; box-shadow: 0 12px 32px rgba(0,0,0,0.1); width: 100%; max-width: 800px; margin-top: 2rem; }
        .gallery-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-actions">
        <button class="gallery-btn" id="toggleGallery">üìÇ –ú–æ—ó –ø—Ä–æ–µ–∫—Ç–∏</button>
    </div>
    
    <h1>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –≤—ñ–¥–µ–æ (3x –£–Ω—ñ–∫–∞–ª—ñ–∑–∞—Ü—ñ—è)</h1>

    <label for="modelSelect">ü§ñ –ú–æ–¥–µ–ª—å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó</label>
<select id="modelSelect">
    <option value="kling">Kling Video (–ê–±—Å—É—Ä–¥ / CCTV)</option>
    <option value="luma">Luma Dream Machine (–ú—ñ–∫—Ä–æ–≤—Å–µ—Å–≤—ñ—Ç–∏ / –î—ñ–æ—Ä–∞–º–∏)</option>
    <option value="minimax">MiniMax Hailuo (Vertical Shorts / ASMR)</option>
</select>

    <label for="imgUrl">–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è (–°—Ç–∞—Ä—Ç–æ–≤–∏–π –∫–∞–¥—Ä)</label>
    <div class="drop-zone" id="dropZone">
        <span class="drop-text" id="dropText">üìÇ –ü–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å —Ñ–æ—Ç–æ –∞–±–æ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å</span>
        <img id="imagePreview" src="" alt="Preview">
        <input type="file" id="fileInput" accept="image/jpeg, image/png, image/webp" style="display: none;">
    </div>
    
    <div class="divider">‚Äî –∞–±–æ ‚Äî</div>
    <input type="text" id="imgUrl" placeholder="–í—Å—Ç–∞–≤—Ç–µ –ø—Ä—è–º–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è (https://...)">

    <label for="prompt">–©–æ –º–∞—î –≤—ñ–¥–±—É–≤–∞—Ç–∏—Å—è? (–ü—Ä–æ–º–ø—Ç)</label>
    <input type="text" id="prompt" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: Stop-motion animation, slow camera push-in">

    <div style="display: flex; gap: 15px; margin-bottom: 1.5rem; background: #f8faff; padding: 15px; border-radius: 10px; border: 1px solid #e1e4e8;">
        <div style="flex: 1;">
            <label for="aspectRatio" style="margin-bottom: 5px;">üì± –§–æ—Ä–º–∞—Ç –≤—ñ–¥–µ–æ</label>
            <select id="aspectRatio" style="margin-bottom: 0; padding: 10px;">
                <option value="9:16">9:16 (TikTok / Shorts)</option>
                <option value="16:9">16:9 (YouTube –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ)</option>
                <option value="1:1">1:1 (Instagram –ö–≤–∞–¥—Ä–∞—Ç)</option>
            </select>
        </div>
        <div style="flex: 1; display: flex; flex-direction: column; justify-content: center;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin: 0; margin-top: 15px;">
                <input type="checkbox" id="loopVideo" style="width: 20px; height: 20px; cursor: pointer;">
                <span>üîÑ –ë–µ–∑—à–æ–≤–Ω–µ –∑–∞—Ü–∏–∫–ª–µ–Ω–Ω—è (Loop)</span>
            </label>
        </div>
    </div>

    <button id="btn" class="primary-btn">‚ú® –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ 3 —É–Ω—ñ–∫–∞–ª—å–Ω—ñ –≤—ñ–¥–µ–æ</button>

    <div id="progressContainer" class="progress-container"><div id="progressBar" class="progress-bar"></div></div>
    <p id="status"></p>
    
    <div id="result" class="video-grid"></div>
</div>

<div class="gallery-overlay" id="galleryOverlay">
    <h2>–Ü—Å—Ç–æ—Ä—ñ—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ–π</h2>
    <div class="gallery-list" id="galleryGrid"></div>
</div>

<script>
    // 1. –õ–û–ì–Ü–ö–ê –§–û–¢–û (Drag & Drop + URL)
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const imagePreview = document.getElementById('imagePreview');
    const dropText = document.getElementById('dropText');
    const imgUrlInput = document.getElementById('imgUrl');
    let base64Image = null;

    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault(); dropZone.classList.remove('dragover');
        if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
    });
    fileInput.addEventListener('change', (e) => { if (e.target.files.length) handleFile(e.target.files[0]); });

    imgUrlInput.addEventListener('input', () => {
        if (imgUrlInput.value.trim() !== "") {
            base64Image = null;
            imagePreview.style.display = 'none';
            dropText.style.display = 'block';
            fileInput.value = "";
        }
    });

    function handleFile(file) {
        if (!file.type.startsWith('image/')) return alert('–¢—ñ–ª—å–∫–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è!');
        const reader = new FileReader();
        reader.onload = (e) => {
            base64Image = e.target.result;
            imagePreview.src = base64Image; 
            imagePreview.style.display = 'block'; 
            dropText.style.display = 'none';
            imgUrlInput.value = ""; 
        };
        reader.readAsDataURL(file);
    }

    // 2. –õ–û–ì–Ü–ö–ê –ì–ê–õ–ï–†–ï–á
    const toggleGallery = document.getElementById('toggleGallery');
    const galleryOverlay = document.getElementById('galleryOverlay');
    
    toggleGallery.onclick = () => {
        const isHidden = galleryOverlay.style.display === 'none' || galleryOverlay.style.display === '';
        galleryOverlay.style.display = isHidden ? 'block' : 'none';
        if (isHidden) loadGallery();
    };

    function loadGallery() {
        const saved = JSON.parse(localStorage.getItem('ai_videos_v2')) || [];
        const grid = document.getElementById('galleryGrid');
        grid.innerHTML = saved.map(item => `
            <div class="video-card">
                <h3>${item.prompt || '–ë–µ–∑ –ø—Ä–æ–º–ø—Ç—É'}</h3>
                <video controls src="${item.urls.tiktok}"></video>
            </div>
        `).reverse().join('');
    }

    function saveToGallery(prompt, urls) {
        const saved = JSON.parse(localStorage.getItem('ai_videos_v2')) || [];
        saved.push({ prompt, urls, date: new Date().toISOString() });
        localStorage.setItem('ai_videos_v2', JSON.stringify(saved));
    }

    // 3. –õ–û–ì–Ü–ö–ê –ó–ê–ü–£–°–ö–£ –¢–ê –û–ü–ò–¢–£–í–ê–ù–ù–Ø
    document.getElementById('btn').onclick = async () => {
        const status = document.getElementById('status');
        const resultDiv = document.getElementById('result');
        const progressBar = document.getElementById('progressBar');
        const progressContainer = document.getElementById('progressContainer');
        const btn = document.getElementById('btn');

        const finalImageSource = base64Image || imgUrlInput.value.trim();

        if (!finalImageSource) return status.innerText = "‚ùå –î–æ–¥–∞–π—Ç–µ —Ñ–æ—Ç–æ –∞–±–æ –≤—Å—Ç–∞–≤—Ç–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è!";
        
        const prompt = document.getElementById('prompt').value;
        const modelSelect = document.getElementById('modelSelect').value;
        
        // –û—Ç—Ä–∏–º—É—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è –∑ –Ω–æ–≤–∏—Ö –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å
        const aspect_ratio = document.getElementById('aspectRatio').value;
        const loop_video = document.getElementById('loopVideo').checked;

        status.innerText = "üöÄ –ó–∞–ø—É—Å–∫... (–≥–µ–Ω–µ—Ä–∞—Ü—ñ—è —Ç–∞ —É–Ω—ñ–∫–∞–ª—ñ–∑–∞—Ü—ñ—è –∑–∞–π–º—É—Ç—å —á–∞—Å)";
        resultDiv.innerHTML = ""; btn.disabled = true;
        progressContainer.style.display = 'block'; progressBar.style.width = '10%';

        let attempts = 0; const MAX_ATTEMPTS = 120; // –û–ø–∏—Ç—É–≤–∞–Ω–Ω—è –¥–æ 10 —Ö–≤–∏–ª–∏–Ω
        
        try {
            // –ö—Ä–æ–∫ 1: –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –∑–∞–ø–∏—Ç –∑ –Ω–æ–≤–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
            const response = await fetch('/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    image_url: finalImageSource, 
                    prompt: prompt, 
                    model_id: modelSelect,
                    aspect_ratio: aspect_ratio,
                    loop_video: loop_video
                })
            });

            if (!response.ok) throw new Error("–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ —Å–µ—Ä–≤–µ—Ä–∞");
            const { request_id, endpoint } = await response.json();
            
            // –ö—Ä–æ–∫ 2: –ß–µ–∫–∞—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç (Polling)
            const pollInterval = setInterval(async () => {
                attempts++;
                progressBar.style.width = `${Math.min((attempts / MAX_ATTEMPTS) * 100, 95)}%`;

                if (attempts > MAX_ATTEMPTS) {
                    clearInterval(pollInterval); status.innerText = "‚è∞ –¢–∞–π–º–∞—É—Ç (–ó–∞–Ω–∞–¥—Ç–æ –¥–æ–≤–≥–æ)"; btn.disabled = false; return;
                }
                
                try {
                    const checkRes = await fetch(`/status`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ request_id, endpoint })
                    });
                    
                    const data = await checkRes.json();

                    if (checkRes.status === 200 && data.status === 'COMPLETED') {
                        // –£–°–ü–Ü–•
                        clearInterval(pollInterval);
                        progressBar.style.width = '100%'; status.innerText = "‚ú® –í—Å—ñ 3 –≤–µ—Ä—Å—ñ—ó –≤—ñ–¥–µ–æ –≥–æ—Ç–æ–≤—ñ!";
                        setTimeout(() => { progressContainer.style.display = 'none'; }, 1000);

                        const { tiktok, insta, youtube } = data.videos;

                        resultDiv.innerHTML = `
                            <div class="video-card">
                                <h3>üéµ TikTok</h3>
                                <video controls autoplay loop muted><source src="${tiktok}" type="video/mp4"></video>
                                <a href="${tiktok}" download class="action-btn">‚¨áÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</a>
                            </div>
                            <div class="video-card">
                                <h3>üì∏ Instagram</h3>
                                <video controls autoplay loop muted><source src="${insta}" type="video/mp4"></video>
                                <a href="${insta}" download class="action-btn">‚¨áÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</a>
                            </div>
                            <div class="video-card">
                                <h3>‚ñ∂Ô∏è YouTube Shorts</h3>
                                <video controls autoplay loop muted><source src="${youtube}" type="video/mp4"></video>
                                <a href="${youtube}" download class="action-btn">‚¨áÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</a>
                            </div>
                        `;
                        saveToGallery(prompt, data.videos);
                        btn.disabled = false;
                    } else if (checkRes.status === 202) {
                        // –ü–†–û–¶–ï–°
                        status.innerText = `‚è≥ ${data.status}`;
                    } else if (checkRes.status === 500) {
                        // –ü–û–ú–ò–õ–ö–ê
                         clearInterval(pollInterval); 
                         status.innerText = `‚ùå –ü–æ–º–∏–ª–∫–∞: ${data.error || '–ù–µ–≤—ñ–¥–æ–º–∏–π –∑–±—ñ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ'}`; 
                         btn.disabled = false;
                         progressContainer.style.display = 'none';
                    }
                } catch (e) { console.error("–ü–æ–º–∏–ª–∫–∞ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è:", e); }
            }, 5000);

        } catch (e) {
            status.innerText = "‚ùå –ü–æ–º–∏–ª–∫–∞: " + e.message; btn.disabled = false; progressContainer.style.display = 'none';
        }
    };
</script>
</body>
</html>