document.getElementById('btn').onclick = async () => {
    const status = document.getElementById('status');
    const resultDiv = document.getElementById('result');
    const imgUrl = document.getElementById('imgUrl').value;
    const prompt = document.getElementById('prompt').value;

    if (!imgUrl) {
        status.innerText = "‚ùå –ë—É–¥—å –ª–∞—Å–∫–∞, –≤—Å—Ç–∞–≤ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Ñ–æ—Ç–æ";
        return;
    }

    status.innerText = "üöÄ –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –∑–∞–ø–∏—Ç—É –¥–æ —Å–µ—Ä–≤–µ—Ä–∞...";
    resultDiv.innerHTML = ""; // –û—á–∏—â—É—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

    try {
        // 1. –ó–ê–ü–£–°–ö –ì–ï–ù–ï–†–ê–¶–Ü–á
        const response = await fetch('/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image_url: imgUrl, prompt: prompt })
        });

        // –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ —Å–µ—Ä–≤–µ—Ä–∞
        if (!response.ok) {
            const errorText = await response.text();
            console.error("–°–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä–Ω—É–≤ HTML –∑–∞–º—ñ—Å—Ç—å JSON. –ú–æ–∂–ª–∏–≤–æ, —à–ª—è—Ö /start –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ:", errorText);
            status.innerText = "–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü–µ—Ä–µ–≤—ñ—Ä –∫–æ–Ω—Å–æ–ª—å (F12).";
            return;
        }

        const data = await response.json();
        const request_id = data.request_id;
        console.log("‚úÖ –û—Ç—Ä–∏–º–∞–Ω–æ ID –∑–∞–ø–∏—Ç—É:", request_id);

        // 2. –¶–ò–ö–õ –ü–ï–†–ï–í–Ü–†–ö–ò –°–¢–ê–¢–£–°–£ (POLLING)
        status.innerText = "‚è≥ –í—ñ–¥–µ–æ –≤ —á–µ—Ä–∑—ñ. –û—á—ñ–∫—É—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ –Ω–µ–π—Ä–æ–º–µ—Ä–µ–∂—ñ...";
        
        const pollInterval = setInterval(async () => {
            try {
                const checkRes = await fetch(`/check/${request_id}`);
                
                if (checkRes.status === 200) {
                    // –í—ñ–¥–µ–æ –≥–æ—Ç–æ–≤–µ!
                    const result = await checkRes.json();
                    clearInterval(pollInterval); // –ó—É–ø–∏–Ω—è—î–º–æ —Ç–∞–π–º–µ—Ä
                    
                    status.innerText = "‚ú® –ì–æ—Ç–æ–≤–æ!";
                    resultDiv.innerHTML = `
                        <video controls autoplay loop style="width:100%; border-radius:12px;">
                            <source src="${result.video.url}" type="video/mp4">
                        </video>
                        <br>
                        <a href="${result.video.url}" target="_blank" style="color: #007bff; text-decoration: none; font-weight: bold;">
                            üîó –í—ñ–¥–∫—Ä–∏—Ç–∏ –ø—Ä—è–º–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –≤—ñ–¥–µ–æ
                        </a>
                    `;
                } else if (checkRes.status === 202) {
                    // –©–µ –≤ –ø—Ä–æ—Ü–µ—Å—ñ
                    status.innerText = "‚è≥ –ù–µ–π—Ä–æ–º–µ—Ä–µ–∂–∞ –ø—Ä–∞—Ü—é—î –Ω–∞–¥ –≤—ñ–¥–µ–æ... (—Ü–µ –∑–∞–∑–≤–∏—á–∞–π 1-2 —Ö–≤)";
                } else {
                    // –Ø–∫–∞—Å—å —ñ–Ω—à–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ
                    console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ —Å—Ç–∞—Ç—É—Å—É:", await checkRes.text());
                }
            } catch (pollError) {
                console.error("–ü–æ–º–∏–ª–∫–∞ –∑–≤'—è–∑–∫—É –ø—ñ–¥ —á–∞—Å –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è:", pollError);
            }
        }, 5000); // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∫–æ–∂–Ω—ñ 5 —Å–µ–∫—É–Ω–¥

    } catch (e) {
        console.error("–ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞ fetch:", e);
        status.innerText = "‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–≤'—è–∑–∫—É –∑ —Å–µ—Ä–≤–µ—Ä–æ–º. –ü–µ—Ä–µ–≤—ñ—Ä, —á–∏ –∑–∞–ø—É—â–µ–Ω–∏–π Railway.";
    }
};